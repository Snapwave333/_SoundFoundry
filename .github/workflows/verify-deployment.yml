name: Verify Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'

jobs:
  headers:
    name: Security Headers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Check security headers
        run: npm run test:headers
        env:
          SITE_URL: https://promptbloom.app
        continue-on-error: false

  dns:
    name: DNS & SSL
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Check DNS and SSL
        run: npm run test:dns
        env:
          SITE_URL: https://promptbloom.app
        continue-on-error: true

  smoke-login:
    name: Authentication Smoke Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Install Playwright browsers
        working-directory: web
        run: npx playwright install chromium

      - name: Run login smoke test
        run: npm run test:login:smoke
        env:
          SITE_URL: https://promptbloom.app
          AUTH_TEST_USER: ${{ secrets.AUTH_TEST_USER }}
          AUTH_TEST_PASS: ${{ secrets.AUTH_TEST_PASS }}
        continue-on-error: true

  accessibility:
    name: Accessibility (Pa11y)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run accessibility tests
        run: |
          npm run test:access -- https://promptbloom.app/ || true
          npm run test:access -- https://promptbloom.app/pricing || true
          npm run test:access -- https://promptbloom.app/about || true
          npm run test:access -- https://promptbloom.app/contact || true
          npm run test:access -- https://promptbloom.app/privacy || true
          npm run test:access -- https://promptbloom.app/terms || true
        continue-on-error: true

  links:
    name: Broken Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Check broken links
        run: npm run test:links
        continue-on-error: true

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run Lighthouse CI
        run: npm run test:lhci
        continue-on-error: true

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: web/.lighthouseci/
          retention-days: 7

      - name: Generate summary
        if: always()
        run: |
          echo "## Lighthouse Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Lighthouse CI completed. Check artifacts for full reports." >> $GITHUB_STEP_SUMMARY
          if [ -f web/.lighthouseci/assertion-results.json ]; then
            echo "### Assertions" >> $GITHUB_STEP_SUMMARY
            cat web/.lighthouseci/assertion-results.json >> $GITHUB_STEP_SUMMARY
          fi

  zap_baseline:
    name: OWASP ZAP Baseline
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: 'https://promptbloom.app'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -m 5 -I'

      - name: Upload ZAP results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-results
          path: report_html.html
          retention-days: 7

      - name: Add ZAP report link to summary
        if: always()
        run: |
          echo "## OWASP ZAP Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä ZAP baseline scan completed. Download the **zap-results** artifact to view the full HTML report." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Review" >> $GITHUB_STEP_SUMMARY
          echo "- Check artifacts for `report_html.html`" >> $GITHUB_STEP_SUMMARY
          echo "- Review high/critical findings" >> $GITHUB_STEP_SUMMARY
          echo "- Verify CSP and security headers" >> $GITHUB_STEP_SUMMARY

  gate:
    name: Verification Gate
    runs-on: ubuntu-latest
    needs: [headers, dns, smoke-login, accessibility, links, lighthouse]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Headers | ${{ needs.headers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DNS & SSL | ${{ needs.dns.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Authentication | ${{ needs.smoke-login.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ needs.accessibility.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Broken Links | ${{ needs.links.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lighthouse | ${{ needs.lighthouse.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.headers.result }}" != "success" ]; then
            echo "‚ùå Security headers check failed"
            exit 1
          fi
          
          if [ "${{ needs.dns.result }}" != "success" ] && [ "${{ needs.dns.result }}" != "skipped" ]; then
            echo "‚ö†Ô∏è DNS/SSL check had issues (may be expected if domain not live)"
          fi
          
          echo "‚úÖ Core verification checks passed"
